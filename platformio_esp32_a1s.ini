; PlatformIO Configuration for ESP32-A1S Audio Board
; ESP32 Marauder with ES8388 codec support
;
; Usage:
; 1. Copy this file to platformio.ini in project root
; 2. Run: pio run -e esp32_a1s
; 3. Flash: pio run -e esp32_a1s -t upload

[platformio]
default_envs = esp32_a1s

[env:esp32_a1s]
platform = espressif32@^6.5.0
board = esp32dev
framework = arduino

; Serial Monitor Settings
monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder
    time
    log2file

; Upload Settings
upload_speed = 921600
upload_port = /dev/ttyUSB0  ; Change to your port (COM3 on Windows)

; Build Flags
build_flags = 
    ; Board Definition
    -D ESP32_A1S
    
    ; Core Settings
    -D ARDUINO_ARCH_ESP32
    -D CONFIG_ARDUHAL_LOG_COLORS=1
    -D CORE_DEBUG_LEVEL=0
    
    ; WiFi Settings
    -D CONFIG_ASYNC_TCP_RUNNING_CORE=1
    -D CONFIG_ASYNC_TCP_USE_WDT=0
    
    ; Memory Optimization
    -D CONFIG_SPIRAM_SUPPORT=0
    -D BOARD_HAS_PSRAM=0
    
    ; TFT Display Settings
    -D USER_SETUP_LOADED=1
    -D ILI9341_DRIVER=1
    -D TFT_WIDTH=240
    -D TFT_HEIGHT=320
    -D TFT_MISO=12
    -D TFT_MOSI=13
    -D TFT_SCLK=14
    -D TFT_CS=15
    -D TFT_DC=2
    -D TFT_RST=4
    -D TFT_BL=27
    -D TOUCH_CS=33
    -D LOAD_GLCD=1
    -D LOAD_FONT2=1
    -D LOAD_FONT4=1
    -D LOAD_FONT6=1
    -D LOAD_FONT7=1
    -D LOAD_FONT8=1
    -D LOAD_GFXFF=1
    -D SMOOTH_FONT=1
    -D SPI_FREQUENCY=27000000
    -D SPI_READ_FREQUENCY=20000000
    
    ; SD Card Settings
    -D SD_CS=5
    -D SD_MISO=12
    -D SD_MOSI=13
    -D SD_SCK=14
    
    ; I2S Audio Codec (ES8388)
    -D HAS_AUDIO_CODEC=1
    -D HAS_I2S_AUDIO=1
    -D PIN_I2S_MCLK=0
    -D PIN_I2S_BCK=27
    -D PIN_I2S_WS=25
    -D PIN_I2S_DOUT=26
    -D PIN_I2S_DIN=35
    -D ES8388_I2C_SDA=33
    -D ES8388_I2C_SCL=32
    -D ES8388_I2C_ADDR=0x10
    -D PA_EN_PIN=21
    
    ; GPS Settings (optional external module)
    -D GPS_TX=17
    -D GPS_RX=16
    -D GPS_SERIAL_INDEX=2
    
    ; Button Definitions
    -D L_BTN=36
    -D U_BTN=13
    -D R_BTN=23
    -D D_BTN=18
    -D C_BTN=5
    
    ; LED Definitions
    -D LED_GREEN=22
    -D LED_RED=19
    
    ; Optimization Flags
    -Os
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections

; Board Configuration
board_build.partitions = min_spiffs.csv
board_build.flash_mode = qio
board_build.f_cpu = 240000000L
board_build.f_flash = 80000000L
board_build.flash_size = 4MB

; Library Dependencies
lib_deps = 
    ; Core Libraries
    bodmer/TFT_eSPI@^2.5.43
    mikalhart/TinyGPSPlus@^1.0.3
    ivanseidel/LinkedList@0.0.0-alpha+sha.dac3874d28
    
    ; BLE Support
    h2zero/NimBLE-Arduino@^1.4.1
    
    ; SD Card
    arduino-libraries/SD@^1.2.4
    
    ; WiFi
    esphome/ESPAsyncWebServer-esphome@^3.1.0
    me-no-dev/AsyncTCP@^1.1.1
    
    ; Audio (optional, for ES8388 codec)
    ; https://github.com/atomic14/esp32-i2s-audio.git
    
    ; JSON (for configuration)
    bblanchon/ArduinoJson@^6.21.4

; Extra Scripts
extra_scripts = 
    pre:scripts/pre_build.py
    post:scripts/post_build.py

; Debug Configuration
[env:esp32_a1s_debug]
extends = env:esp32_a1s
build_type = debug
build_flags = 
    ${env:esp32_a1s.build_flags}
    -D CORE_DEBUG_LEVEL=5
    -D DEBUG_ESP_PORT=Serial
    -D DEBUG_ESP_WIFI=1
    -D DEBUG_ESP_HTTP_CLIENT=1
monitor_filters = 
    esp32_exception_decoder
    time
    log2file
    colorize

; OTA Update Configuration
[env:esp32_a1s_ota]
extends = env:esp32_a1s
upload_protocol = espota
upload_port = 192.168.1.100  ; Change to your ESP32-A1S IP
upload_flags = 
    --port=3232
    --auth=marauder

; Minimal Build (for troubleshooting)
[env:esp32_a1s_minimal]
extends = env:esp32_a1s
build_flags = 
    -D ESP32_A1S
    -D ARDUINO_ARCH_ESP32
    -D CORE_DEBUG_LEVEL=0
    -Os
lib_deps = 
    bodmer/TFT_eSPI@^2.5.43
